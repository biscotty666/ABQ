---
title: "Demographics"
format: gfm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print = FALSE)
```

```{r}
#| message: false
library(tidycensus)
library(tidyverse)
library(ggspatial)
library(sf)
library(janitor)
library(gt)
library(areal)
library(glue)
library(spdep)
library(tigris)
library(data.table)
options(tigris_use_cache = TRUE)
```

# Introduction

In this article, I would like to do a comparative analysis of various economic factors such as income, housing value, poverty and equality among the city council districts of Albuquerque. I will obtain the demographic data from `census.gov` using `tidycensus`. After cleaning, the data will be spatially joined with the council districts in order to produce both comparitive summaries of aggregated data, but also distribution analyses of the data. Finally, I will explore clustering of the data points.

Dealing with "real-life" data.

# Data Preparation

## City Council Districts

I will start with the easy part, obtaining the boundaries for the city council districts. There are just two twists here: the data from the city website is useless, and; there's a big hole in the middle of Albuquerque, which is the township of Los Ranchos. The Albuquerque website provides a wealth of data, although it is not necessarily well thought-out or well-maintained. In many of the data sets, the relevant data is contained in tables embeded in html, all of which are in a single variable in the data set. In this case, the problem is worse: the website only provides the councilors' names, not district numbers, and the names are for councilors from several years ago!

Fortunately, the county website provides a reasonable dataset in the form of a zipped shapefile. And they provide a geometry for Los Ranchos. Los Ranchos is sort of the Beverly Hills of Albuquerque, in the sense that it is a separate enclave which is (almost) entirely surrounded by Albuquerque, and where the largest properties and mansions are located.

The data portal for Bernalillo county is not very friendly for programmatic downloading. My first effort to download and unzip the file containing the city council boundaries failed to produce a usable file. Adding the argument `method = "curl"` allowed me to download the file which is a zipped shapefile.

```{r}
#| eval: false
download.file("https://www.berncoclerk.gov/wp-content/uploads/2025/07/BERNCO_CLERKJuly2025.gdb_.zip", "data/bernalillo.zip", method = "curl")
unzip("data/bernalillo.zip", overwrite = T)
```

The only variables I'm interested in are the district number and geometry. I'll just grab that, fix the variable name, and make the content more descriptive for easy mapping.

```{r}
council_dists_bc <- st_read("data/BC_CityCouncil/ABQ_CityCouncils.shp") %>%
  select(district = DISTRICTNU) %>%
  mutate(district = paste("District", district))
council_dists_bc
```

The downloaded file for Los Ranchos was not complete even with the additional argument, so I had to manually download the file.

```{r}
#| eval: false
download.file("https://www.berncoclerk.gov/wp-content/uploads/2023/02/LosRanchos.zip", "data/test.zip", method = "curl")
unzip("data/LosRanchos.zip")
```

I'll combine the files and transform to an appropriate projection.

```{r}
los_ranchos <- st_read("data/LosRanchos/LosRanchos.shp") %>%
  select(district = Name)

st_crs(los_ranchos) == st_crs(council_dists_bc)
crsuggest::suggest_crs(council_dists_bc) %>% head(2)

council_dists <- rbind(council_dists_bc, los_ranchos) %>%
  st_transform(6528)
```

I'll plot the district boundaries with `ggplot`, adding a base map with `ggspatial::annotation_map_tile`.

```{r}
ggplot(council_dists) +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.7
  ) +
  geom_sf(aes(color = district), fill = NA, linewidth = 1) +
  geom_sf_text(aes(label = district)) +
  theme_void() +
  labs(title = "Albuquerque Council Districts")
```

## Demographics

I want to look at some basic demographic and economic information. I will use `tidycensus` to download data from `census.gov`, using the information from 2023's five-year American Community Survey. I want tract level data for my study area. I want to compare to state-wide and country-wide data, so I'll grab those at a less detailed level.

```{r}
vars <- c(
  med_house_value = "B25077_001",
  income_hh = "B19001_001",
  population = "B01003_001",
  gini = "B19083_001",
  med_age = "B01002_001",
  in_poverty = "B17001A_002"
)
```

```{r}
#| eval: false
bern_data <- get_acs(
  geography = "tract",
  state = "NM",
  county = "Bernalillo",
  variables = vars,
  output = "wide",
  year = 2023,
  geometry = T,
  cache_table = T
)

st_write(bern_data, "data/demographics.gpkg", layer = "county", append = F)

nm_data <- get_acs(
  geography = "county",
  state = "NM",
  variables = vars,
  output = "wide",
  year = 2023,
  geometry = T,
  cache_table = T
)

st_write(nm_data, "data/demographics.gpkg", layer = "state", append = F)

us_data <- get_acs(
  geography = "state",
  variables = vars,
  output = "wide",
  year = 2023,
  geometry = T,
  cache_table = T
)

st_write(us_data, "data/demographics.gpkg", layer = "country", append = F)
```

I would like to compare education levels as well. The data is broken down into 25 variables, so I will group them a little to make this easier. I'm also going to drop the margin of error information.

```{r}
#| eval: false
bern_edu <- get_acs(
  geography = "tract",
  state = "NM",
  county = "Bernalillo",
  table = "B15003",
  output = "wide",
  year = 2023,
  geometry = T,
  cache_table = T
) %>%
  select(-2) %>%
  select(!ends_with("M")) %>%
  mutate(
    no_hs_deg = rowSums(across("B15003_002E":"B15003_016E")),
    hs_some_colleg = rowSums(across("B15003_017E":"B15003_020E")),
    bach_assoc_deg = rowSums(across("B15003_021E":"B15003_022E")),
    grad_deg = rowSums(across("B15003_023E":"B15003_025E"))
  ) %>%
  select(-c("B15003_001E":"B15003_025E"))

st_write(bern_edu, "data/demographics.gpkg", layer = "education", append = F)
```

```{r}
bernalillo_edu <-
  st_read("data/demographics.gpkg", layer = "education")
bernalillo_demographics <-
  st_read("data/demographics.gpkg", layer = "county")
```

```{r}
summary(bernalillo_demographics)
```

There is clean-up work to do here. There are some NAs, some areas with 0 population, an an unneeded NAME column, and the ugly variable names to deal with. I also need to make sure it is in the correct crs. First I'll fix the names and transform the coordinates, and do a simple join with the educational table based on the GEOID.

```{r}
fix_names <- function(df) {
  df %>%
    rename_with(~ sub("E$", "", .)) %>%
    rename_with(~ sub("M$", "_moe", .))
}

bernalillo_demographics <-
  bernalillo_demographics %>%
  select(-2) %>% 
  fix_names() %>%
  st_transform(6528)


bernalillo_demographics <- bernalillo_demographics %>%
  left_join(st_drop_geometry(bernalillo_edu), by = "GEOID") %>%
  select(!ends_with("moe"))
```

```{r}
summary(bernalillo_demographics)
```

First, I will see how many areas have 0 population.

```{r}
bernalillo_demographics %>% filter(population == 0)
```

These contain no information, so I'll drop them. With regarding to the remaining missing values, there are so few that I'll just replace them with averages.

```{r}
bernalillo_demographics <- bernalillo_demographics %>%
  filter(population != 0) %>% 
  mutate(
    med_house_value = ifelse(is.na(med_house_value),
      median(med_house_value, na.rm = T),
      med_house_value
    ),
    gini = ifelse(is.na(gini),
      mean(gini, na.rm = T),
      gini
    )
  )

summary(bernalillo_demographics)
```

```{r}
#| eval: false
bernalillo_demographics_dt[, `:=`(
  med_house_value = ifelse(is.na(med_house_value),
                           median(med_house_value, na.rm = T),
                           med_house_value),
  gini = ifelse(is.na(gini),
                mean(gini, na.rm = T),
                gini)
)]
summary(bernalillo_demographics_dt)
```

Most of the data seems normal. I am curious about the tract(s) with no household income and very small populations. Are they the same?

```{r}
bernalillo_demographics %>% 
  filter(income_hh < 100 | population < 150)
```

The duplicate house value is suspicious, the income for the first is clearly wrong. I'm going to remove the second record, since there are so few people, and use an average value for the income in the first record.

```{r}
bernalillo_demographics <- 
  bernalillo_demographics %>% 
  filter(population > 20) %>% 
  mutate(
    income_hh = ifelse(income_hh == 0, median(income_hh), income_hh)
  )
```


```{r}
summary(bernalillo_demographics)
```

I would also like to calculate population density and percentages for the poverty and education variables. For population density, I'll need areas for each tract changing to square kilometers with the `units` package. I'll do the same for square miles.

```{r}
library(units)
st_crs(bernalillo_demographics)
bernalillo_demographics$area <- 
  st_area(bernalillo_demographics) %>% 
  set_units(km^2)

bernalillo_demographics$area_sm <- 
  st_area(bernalillo_demographics) %>% 
  set_units(mi^2)

bernalillo_demographics$pop_dens <-
  bernalillo_demographics$population / bernalillo_demographics$area

summary(bernalillo_demographics$pop_dens)
```

```{r}
demo_pcts <- 
  modify(bernalillo_demographics[7:11], 
       \(x) x / bernalillo_demographics$population) %>% 
  rename_with(~ sub("$", "_pct", .), .cols = everything()) %>% 
  st_drop_geometry()

bernalillo_demographics <- 
  bernalillo_demographics %>% 
  cbind(demo_pcts)

summary(bernalillo_demographics)
```

```{r}
library(rmapshaper)
cd_demographics <- ms_clip(
  target = bernalillo_demographics, clip = council_dists,
  remove_slivers = T
)

```


```{r}
ggplot() +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.5
  ) +
  geom_sf(data = cd_demographics, aes(fill = population), alpha = 0.4) +
  geom_sf(data = council_dists, color = "red", fill = NA) +
  scale_fill_viridis_c() +
  theme_void()
```

```{r}
ggplot() +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.5
  ) +
  geom_sf(data = cd_demographics, aes(fill = pop_dens), alpha = 0.4) +
  geom_sf(data = council_dists, aes(color = district), fill = NA, linewidth = 1) +
  scale_fill_viridis_c() +
  scale_color_viridis_d() +
  theme_void()
```

```{r}
bern_blocks <- blocks(state = "NM", county = "Bernalillo", year = 2020) %>%
  st_transform(st_crs(bernalillo_demographics))
names(bern_blocks)
```

```{r}
names(bernalillo_demographics)
bern_tract_ext <- bernalillo_demographics %>%
  select(c(population, no_hs_deg, hs_equivalent, some_college, bach_assoc_deg, grad_deg))
bern_tract_int <- bernalillo_demographics %>%
  select(med_house_value, income_hh, income_pc, gini, med_age)
```

```{r}
bern_demo_int <- interpolate_pw(
  bern_tract_ext, council_dists,
  to_id = "district", extensive = TRUE,
  weights = bern_blocks, weight_column = "POP20"
)

bern_demo_ext <- interpolate_pw(
  bern_tract_int, council_dists,
  to_id = "district", extensive = FALSE,
  weights = bern_blocks, weight_column = "POP20"
)

council_totals <- cbind(
  bern_demo_int %>% arrange(district),
  bern_demo_ext %>% arrange(district) %>% st_drop_geometry()
)
```

```{r}
names(council_totals)
```

```{r}
council_totals %>%
  st_drop_geometry() %>%
  select(district, population, med_house_value, income_hh, income_pc, med_age, gini) %>%
  gt(rowname_col = "district") %>%
  cols_label(
    population = "Population",
    med_house_value = "Med House Value",
    income_hh = "HH Income",
    income_pc = "PC Income",
    med_age = "Age",
    gini = "GINI"
  ) %>%
  tab_header(
    title = md("**Basic Demographics for Albuquerque**")
  ) %>%
  tab_source_note(
    source_note = md("*Source: census.gov, acs5, 2023*")
  ) %>%
  opt_stylize(style = 2) %>%
  fmt_currency(
    columns = c(med_house_value, income_hh, income_pc),
    decimals = 0
  ) %>%
  fmt_number(columns = "med_age", decimals = 1) %>%
  fmt_number(columns = "gini", decimals = 3) %>%
  fmt_number(columns = "population", decimals = 0)
```

Replace NAs with median value for district

```{r}
bernalillo_demographics$area <- st_area(bernalillo_demographics)

names(bern_by_dist)

bern_by_dist <- st_intersection(bernalillo_demographics, council_dists) %>%
  group_by(GEOID) %>%
  mutate(weight = area / sum(area)) %>%
  mutate(
    population_w = population * weight,
    no_hs_deg_w = no_hs_deg * weight,
    hs_equivalent_w = hs_equivalent * weight,
  ) %>%
  arrange(GEOID)
bern_by_dist

plot(bern_by_dist)
```

## Population

```{r}
library(data.table)
demographics_dt <- demographics %>%
  st_drop_geometry() %>%
  as.data.table()
```

```{r}
income <- demographics_dt[income_hh > 10]
```

```{r}
ggplot(income, aes(income_hh)) +
  geom_histogram(bins = 15) +
  facet_wrap(~district) +
  labs(
    title = "2023 Household Income in Albuquerque, NM",
    subtitle = "By district",
    caption = "Source: census.gov ACS"
  )
```

```{r}
ggplot(demographics, aes(x = district, y = income_hh)) +
  geom_boxplot(aes(fill = district)) +
  theme_bw() +
  labs(
    y = "Household Income",
    title = "2023 Household Income in Albuquerque, NM",
    subtitle = "By district",
    caption = "Source: census.gov ACS"
  ) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank()
  )
```
