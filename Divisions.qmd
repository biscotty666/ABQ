---
title: "City Divisions"
format: gfm
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print = FALSE)
```

```{r}
#| message: false
library(tidycensus)
library(data.table)
library(tidyverse)
library(ggspatial)
library(geojsonsf)
library(sf)
library(rvest)
library(janitor)
```

# City Council

```{r}
# download.file("https://data.cabq.gov/government/citycouncildistricts/CityCouncilDistricts.kmz", "data/council-districts.kmz")

# unzip("data/council-districts.kmz")
# file.rename("data/doc.kml", "data/council-districts.kml")
# file.remove("data/council-districts.kmz")
# council_dists <- st_read("data/council-districts.kml")[, -2]
# dist_num <- c(4, 7, 3, 2, 6, 9, 8, 5, 1)
# district <- paste("District", dist_num)
# council_dists$district <- district
# council_dists <- council_dists[, -1]
# st_write(council_dists, "data/abq-divisions.gpkg", layer = "council", append = F)

council_dists <- st_read("data/abq-divisions.gpkg", layer = "council")
```

```{r}
ggplot(council_dists) +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.7
  ) +
  geom_sf(aes(color = district), fill = NA, linewidth = 1) +
  geom_sf_text(aes(label = district)) +
  theme_void() +
  labs(title = "Albuquerque Council Districts") +
  coord_sf(crs = 32113, datum = 32113)
```

# Police commands

```{r}
# download.file("https://coagisweb.cabq.gov/arcgis/rest/services/public/adminboundaries/MapServer/8/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson", "data/police_commands.geojson")

# police_commands <- st_read("data/police_commands.geojson")
# police_commands <- clean_names(police_commands)
# st_write(police_commands, "data/abq-divisions.gpkg", layer = "police")

police_commands <- st_read("data/abq-divisions.gpkg", layer = "police")
```

```{r}
ggplot(police_commands) +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.7
  ) +
  geom_sf(aes(color = area_command), fill = NA, linewidth = 1) +
  geom_sf_text(aes(label = area_command)) +
  theme_void() +
  labs(
    title = "Albuquerque Police Command Areas",
    caption = "Source: https://data.cabq.gov"
  ) +
  coord_sf(crs = 32113, datum = 32113)
```

# Parks and Open Space

```{r}
url_openspace <- "https://data.cabq.gov/community/openspace/CityOpenSpace.kmz"
download.file(url_openspace, "data/openspace.kmz")
unzip("data/openspace.kmz", exdir = "data/")
file.rename("data/doc.kml", "data/openspace.kml")
file.remove("data/openspace.kmz")

openspace <- st_read("data/openspace.kml")
openspace <- clean_names(openspace)
names(openspace)
```

```{r}
description_html <- openspace$description
description <- map_dfr(description_html, ~ {
  table <- read_html(.x) %>% html_table()
  table[[2]]
},
.id = "id_row"
) %>%
  pivot_wider(names_from = "X1", values_from = "X2") %>%
  clean_names()

openspace <- openspace[, -2] %>%
  cbind(description) %>%
  select(-"name.1")

st_write(openspace, "data/abq-divisions.gpkg", layer = "openspace")
```


```{r}
ggplot(openspace) +
  annotation_map_tile(
    type = "osm",
    cachedir = "~/.cache/maps/",
    zoomin = -1,
    alpha = 0.7
  ) +
  geom_sf(
    color = "darkgreen", linewidth = 0.5,
    aes(fill = status)
  ) +
  theme_void() +
  labs(
    title = "Albuquerque Open Space",
    caption = "Source: https://data.cabq.gov"
  ) +
  coord_sf(crs = 32113, datum = 32113)
```

```{r}
library(tigris)
options(tigris_use_cache = TRUE)
```


```{r}
vars <- c("B25077_001", "B19001_001", "B01003_001", "B19013_001", "B19083_001")
vars_desc <- c("med_house_value", "income_hh", "population", "income_pc", "gini")
vars_e <- map_chr(vars, \(x) paste0(x, "E"))
vars_m <- map_chr(vars, \(x) paste0(x, "M"))
vars_desc_m <- map_chr(vars_desc, \(x) paste0(x, "_moe"))
```

```{r}
bern_data <- get_acs(
  geography = "tract",
  state = "NM",
  county = "Bernalillo",
  variables = vars,
  output = "wide",
  year = 2023,
  geometry = T,
  cache_table = T
)
bern_data
```

```{r}
names(bern_data)[names(bern_data) %in% vars_e] <- vars_desc
names(bern_data)[names(bern_data) %in% vars_m] <- vars_desc_m
bern_data <- bern_data %>% select(-NAME, everything())
bern_data
st_write(bern_data, "data/bernalillo-demogrphics.gpkg")
```

